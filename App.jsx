import React,{useState}from'react';import ImageCard from'./components/ImageCard.jsx';import{analyzeImage,analyzeHeatmapOptional}from'./utils/imageAnalysis.js';export default function App(){const[files,setFiles]=useState([]);const[results,setResults]=useState([]);const[heatmap,setHeatmap]=useState(null);const[heatRes,setHeatRes]=useState(null);const[busy,setBusy]=useState(false);const onPickFiles=e=>{const list=Array.from(e.target.files||[]);setFiles(list);setResults([])};const onDrop=e=>{e.preventDefault();const list=Array.from(e.dataTransfer.files||[]);setFiles(list.filter(f=>f.type.startsWith('image/')))};const run=async()=>{if(!files.length)return;setBusy(true);const out=[];for(const f of files)out.push(await analyzeImage(f,{maxSize:512}));setResults(out);setBusy(false)};const onHeatPick=e=>{const f=e.target.files?.[0];setHeatmap(f||null);setHeatRes(null)};const runHeat=async()=>{if(!heatmap)return;setHeatRes(await analyzeHeatmapOptional(heatmap,{grid:16,maxSize:512}))};const overall=(()=>{if(!results.length)return null;const avg=a=>a.reduce((x,y)=>x+y,0)/a.length;return{risk:avg(results.map(r=>r.channelingRisk)),donut:avg(results.map(r=>r.donutScore)),center:avg(results.map(r=>r.centerScore)),asym:avg(results.map(r=>r.asymmetryScore)),hot:avg(results.map(r=>r.hotspotScore))}})();const advice=(()=>{if(!results.length)return[];const tips=[];const r=overall;if(!r)return tips;if(r.risk>0.65){tips.push('Riesgo alto: mejora WDT, nivelado y tampeo.');tips.push('Considera puck screen y revisar headspace (1–2 mm).');tips.push('Si hay donut, intenta un poco más fino o ratio ≈ 1:2.')}else if(r.risk>0.4){tips.push('Riesgo medio: WDT más exhaustivo (multi-ángulo) y nivelado plano.');tips.push('Verifica carga de canasta (±2 g) y evita golpes laterales.')}else{tips.push('Uniformidad razonable. Mantén técnica consistente: WDT + nivelado + tampeo.')}if(r.donut>0.5)tips.push('Anillo/donut: borde más claro → revisa altura de llenado y molienda.');if(r.center>0.5)tips.push('Canal central: cuida distribución en el centro y evita golpes fuertes.');if(r.asym>0.5)tips.push('Flujo desigual: comprueba nivelado y que el tampeo sea perpendicular.');if(r.hot>0.5)tips.push('Microjets/spritz: indica rutas preferenciales → WDT + tampeo uniforme.');return tips})();return(<div className='container'><div className='title'>Puck Diagnosis</div><div className='muted'>Sube varias fotos del puck tras la extracción. Opcional: añade un heat map.</div><div className='sp'></div><div className='grid cols-2'><div className='card'><div className='muted small'>Fotos del puck (arrastra y suelta o selecciona)</div><div className='sp'></div><div className='drop' onDrop={onDrop} onDragOver={e=>e.preventDefault()}><input className='input' type='file' accept='image/*' multiple onChange={onPickFiles}/><div className='small muted'>Recomendación: foto cenital, luz pareja, puck completo.</div></div><div className='sp'></div><button className='btn' onClick={run} disabled={!files.length||busy}>{busy?'Analizando…':'Analizar pucks'}</button></div><div className='card'><div className='muted small'>Heat map (opcional)</div><div className='sp'></div><input className='input' type='file' accept='image/*' onChange={onHeatPick}/><div className='sp'></div><button className='btn secondary' onClick={runHeat} disabled={!heatmap}>Analizar heat map</button>{!!heatRes&&(<><div className='sp'></div><div className='pill'>Uniformidad: <strong>{Math.round(heatRes.uniformity*100)}%</strong></div><div className='small muted'>σ = {(heatRes.std).toFixed(3)} · μ = {(heatRes.mean).toFixed(3)}</div></>)}</div></div>{!!overall&&(<><div className='sp'></div><div className='card'><div className='flex' style={{justifyContent:'space-between'}}><div className='pill'>Diagnóstico global</div><div className='pill'>Riesgo medio: <strong>{Math.round(overall.risk*100)}%</strong></div></div><div className='sp'></div><table className='table'><thead><tr><th>Métrica</th><th>Valor</th></tr></thead><tbody><tr><td>Donut</td><td>{Math.round(overall.donut*100)}%</td></tr><tr><td>Central</td><td>{Math.round(overall.center*100)}%</td></tr><tr><td>Asimetría</td><td>{Math.round(overall.asym*100)}%</td></tr><tr><td>Hotspots</td><td>{Math.round(overall.hot*100)}%</td></tr></tbody></table><div className='sp'></div><div className='muted small'>Interpretación: 0% = sin evidencia, 100% = evidencia muy alta.</div></div></>)}{!!results.length&&(<><div className='sp'></div><div className='grid cols-2'>{files.map((f,i)=>(<ImageCard key={i} file={f} result={results[i]} index={i}/>))}</div></>)}{advice.length>0&&(<><div className='sp'></div><div className='card'><div className='pill'>Sugerencias</div><ul>{advice.map((t,i)=>(<li key={i} className='small'>{t}</li>))}</ul></div></>)}<div className='sp'></div><div className='muted small'>Heurístico; depende de luz/encuadre. Úsalo como guía junto a EY/TDS/ratio.</div></div>) }